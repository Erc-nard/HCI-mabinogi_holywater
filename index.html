<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마비노기 성수 시뮬레이터</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #111827; /* Tailwind gray-900 */
    }
    .tier-common { color: #d1d5db; } /* gray-300 */
    .tier-uncommon { color: #4ade80; } /* green-400 */
    .tier-rare { color: #60a5fa; } /* blue-400 */
    .tier-legendary { color: #facc15; } /* yellow-400 */
    .option-appear {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    /* Custom scrollbar for a better look */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1f2937; /* gray-800 */
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: #4b5563; /* gray-600 */
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #6b7280; /* gray-500 */
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react": "https://esm.sh/react@18.2.0"
  }
}
</script>
</head>
<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script type="module">
    import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
    import ReactDOM from 'react-dom/client';

    const OPTION_TEMPLATES = [
      // Legendary (Total: 0.5%)
      { name: '최대 대미지', type: 'stat', range: [21, 30], unit: '증가', tier: 'legendary', probability: 0.0015 },
      { name: '마법 공격력', type: 'stat', range: [21, 30], unit: '증가', tier: 'legendary', probability: 0.0015 },
      { name: '공격 속도 세트 효과', type: 'set', range: [1, 1], unit: '증가', tier: 'legendary', probability: 0.001 },
      { name: '배쉬 강화 세트 효과', type: 'set', range: [1, 1], unit: '증가', tier: 'legendary', probability: 0.0005 },
      { name: '매그넘 샷 강화 세트 효과', type: 'set', range: [1, 1], unit: '증가', tier: 'legendary', probability: 0.0005 },

      // Rare (Total: 4.5%)
      { name: '최대 대미지', type: 'stat', range: [11, 20], unit: '증가', tier: 'rare', probability: 0.005 },
      { name: '마법 공격력', type: 'stat', range: [11, 20], unit: '증가', tier: 'rare', probability: 0.005 },
      { name: '크리티컬', type: 'stat', range: [4, 5], unit: '% 증가', tier: 'rare', probability: 0.01 },
      { name: '크리티컬 대미지', type: 'stat', range: [3, 4], unit: '% 증가', tier: 'rare', probability: 0.01 },
      { name: '보호', type: 'stat', range: [2, 3], unit: '증가', tier: 'rare', probability: 0.005 },
      { name: '피어싱 저항', type: 'stat', range: [1, 1], unit: '증가', tier: 'rare', probability: 0.005 },
      { name: '음악 버프 효과', type: 'stat', range: [1, 1], unit: '증가', tier: 'rare', probability: 0.005 },

      // Uncommon (Total: 25%)
      { name: '최대 대미지', type: 'stat', range: [6, 10], unit: '증가', tier: 'uncommon', probability: 0.02 },
      { name: '마법 공격력', type: 'stat', range: [6, 10], unit: '증가', tier: 'uncommon', probability: 0.02 },
      { name: '4대 속성 연금 대미지', type: 'stat', range: [10, 30], unit: '증가', tier: 'uncommon', probability: 0.03 },
      { name: '마리오네트 최대 대미지', type: 'stat', range: [10, 30], unit: '증가', tier: 'uncommon', probability: 0.03 },
      { name: '크리티컬', type: 'stat', range: [1, 3], unit: '% 증가', tier: 'uncommon', probability: 0.05 },
      { name: '보호', type: 'stat', range: [1, 1], unit: '증가', tier: 'uncommon', probability: 0.05 },
      { name: '체력', type: 'stat', range: [15, 30], unit: '증가', tier: 'uncommon', probability: 0.025 },
      { name: '지력', type: 'stat', range: [15, 30], unit: '증가', tier: 'uncommon', probability: 0.025 },

      // Common (Total: 70%)
      { name: '최대 대미지', type: 'stat', range: [1, 5], unit: '증가', tier: 'common', probability: 0.07 },
      { name: '마법 공격력', type: 'stat', range: [1, 5], unit: '증가', tier: 'common', probability: 0.07 },
      { name: '생명력', type: 'stat', range: [1, 100], unit: '증가', tier: 'common', probability: 0.1 },
      { name: '마나', type: 'stat', range: [1, 100], unit: '증가', tier: 'common', probability: 0.1 },
      { name: '스태미나', type: 'stat', range: [1, 100], unit: '증가', tier: 'common', probability: 0.1 },
      { name: '체력', type: 'stat', range: [1, 15], unit: '증가', tier: 'common', probability: 0.04 },
      { name: '지력', type: 'stat', range: [1, 15], unit: '증가', tier: 'common', probability: 0.04 },
      { name: '솜씨', type: 'stat', range: [1, 15], unit: '증가', tier: 'common', probability: 0.04 },
      { name: '의지', type: 'stat', range: [1, 15], unit: '증가', tier: 'common', probability: 0.04 },
      { name: '행운', type: 'stat', range: [1, 15], unit: '증가', tier: 'common', probability: 0.04 },
      { name: '밸런스', type: 'stat', range: [1, 5], unit: '% 증가', tier: 'common', probability: 0.06 },
    ];


    const TIER_CLASSES = {
      common: 'tier-common',
      uncommon: 'tier-uncommon',
      rare: 'tier-rare',
      legendary: 'tier-legendary',
    };

    const App = () => {
      const [price, setPrice] = useState(() => localStorage.getItem('holyWaterPrice') || '1000000');
      const [tryCount, setTryCount] = useState(0);
      const [currentOption, setCurrentOption] = useState(null);
      const [history, setHistory] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isSimulating, setIsSimulating] = useState(false);
      const [targetOption, setTargetOption] = useState('');
      const [isAutoSimulating, setIsAutoSimulating] = useState(false);
      const simulationIntervalRef = useRef(null);
      const [copyButtonText, setCopyButtonText] = useState('결과 공유하기');

      useEffect(() => {
        localStorage.setItem('holyWaterPrice', price);
      }, [price]);

      const totalCost = useMemo(() => {
        const numericPrice = BigInt(price.replace(/,/g, '') || '0');
        return BigInt(tryCount) * numericPrice;
      }, [tryCount, price]);

      const uniqueOptionNames = useMemo(() => {
        const names = new Set(OPTION_TEMPLATES.map(opt => opt.name));
        return Array.from(names).sort((a, b) => a.localeCompare(b));
      }, []);

      const getRandomOption = useCallback(() => {
        let random = Math.random() * OPTION_TEMPLATES.reduce((sum, t) => sum + t.probability, 0);
        let selectedTemplate = null;

        for (const template of OPTION_TEMPLATES) {
          if (random < template.probability) {
            selectedTemplate = template;
            break;
          }
          random -= template.probability;
        }

        if (!selectedTemplate) {
          selectedTemplate = OPTION_TEMPLATES[OPTION_TEMPLATES.length - 1]; // Fallback
        }
        
        const [min, max] = selectedTemplate.range;
        const skewedRandom = Math.pow(Math.random(), 2.5); 
        const value = min + Math.floor(skewedRandom * (max - min + 1));
        
        const finalName = `${selectedTemplate.name} ${value}${selectedTemplate.unit.startsWith('%') ? '' : ' '}${selectedTemplate.unit}`;

        return {
            name: finalName,
            tier: selectedTemplate.tier,
        };
      }, []);

      const runSimulationStep = useCallback(() => {
        const newOption = getRandomOption();
        setTryCount(prev => prev + 1);
        setCurrentOption(newOption);
        setHistory(prev => [newOption, ...prev].slice(0, 100));
        return newOption;
      }, [getRandomOption]);
      
      const handleSimulate = useCallback(() => {
        if (isSimulating || isAutoSimulating) return;
        setIsSimulating(true);
        setTimeout(() => {
          runSimulationStep();
          setIsSimulating(false);
        }, 100);
      }, [runSimulationStep, isSimulating, isAutoSimulating]);

      const handleStopAutoSimulate = useCallback(() => {
        if (simulationIntervalRef.current) {
            clearTimeout(simulationIntervalRef.current);
            simulationIntervalRef.current = null;
        }
        setIsAutoSimulating(false);
      }, []);

      const handleAutoSimulate = useCallback(() => {
          if (!targetOption) return;
          setIsAutoSimulating(true);

          const autoSimulateLoop = () => {
              const newOption = runSimulationStep();
              if (newOption.name.startsWith(targetOption)) {
                  handleStopAutoSimulate();
              } else {
                  simulationIntervalRef.current = window.setTimeout(autoSimulateLoop, 0);
              }
          };
          autoSimulateLoop();
      }, [targetOption, runSimulationStep, handleStopAutoSimulate]);
      
      useEffect(() => {
        return () => {
          if (simulationIntervalRef.current) {
            clearTimeout(simulationIntervalRef.current);
          }
        };
      }, []);

      const handleReset = useCallback(() => {
        handleStopAutoSimulate();
        setTryCount(0);
        setCurrentOption(null);
        setHistory([]);
        setTargetOption('');
      }, [handleStopAutoSimulate]);

      const formatNumber = (num) => {
        if (typeof num === 'string') {
          if (num === '') return '';
          const sanitizedNum = num.replace(/,/g, '');
          if (/^\\d+$/.test(sanitizedNum)) {
            return BigInt(sanitizedNum).toLocaleString('ko-KR');
          }
          return num;
        }
        return num.toLocaleString('ko-KR');
      };

      const handlePriceChange = (e) => {
        const value = e.target.value.replace(/,/g, '');
        if (!isNaN(Number(value)) || value === '') {
            setPrice(value);
        }
      };
      
      const handleShare = () => {
        if (!currentOption) {
            alert('먼저 시뮬레이션을 실행해주세요.');
            return;
        }
        const shareText = `${tryCount}회 만에 [${currentOption.name}] 획득! (총 비용: ${formatNumber(totalCost)} G)`;
        navigator.clipboard.writeText(shareText).then(() => {
            setCopyButtonText('복사 완료!');
            setTimeout(() => {
                setCopyButtonText('결과 공유하기');
            }, 2000);
        }).catch(err => {
            console.error('클립보드 복사 실패:', err);
            alert('결과를 복사하는 데 실패했습니다.');
        });
      };

      const ProbabilityModal = () => (
        React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4", onClick: () => setIsModalOpen(false) },
          React.createElement('div', { className: "bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-y-auto", onClick: e => e.stopPropagation() },
            React.createElement('div', { className: "p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800" },
              React.createElement('h3', { className: "text-xl font-bold text-yellow-400" }, '옵션 확률표'),
              React.createElement('button', { onClick: () => setIsModalOpen(false), className: "text-gray-400 hover:text-white" },
                React.createElement('i', { className: "fas fa-times fa-lg" })
              )
            ),
            React.createElement('div', { className: "p-6" },
              React.createElement('table', { className: "w-full text-left" },
                React.createElement('thead', null,
                  React.createElement('tr', { className: "border-b border-gray-600" },
                    React.createElement('th', { className: "py-2" }, '옵션'),
                    React.createElement('th', { className: "py-2" }, '적용 수치 범위'),
                    React.createElement('th', { className: "py-2" }, '등급'),
                    React.createElement('th', { className: "py-2 text-right" }, '확률')
                  )
                ),
                React.createElement('tbody', null,
                  OPTION_TEMPLATES.map((option, index) => (
                    React.createElement('tr', { key: index, className: "border-b border-gray-700 last:border-b-0" },
                      React.createElement('td', { className: `py-3 ${TIER_CLASSES[option.tier]}` }, option.name),
                      React.createElement('td', { className: "py-3 text-gray-300" },
                        option.range[0] === option.range[1] 
                          ? `${option.range[0]}${option.unit}`
                          : `${option.range[0]} ~ ${option.range[1]}${option.unit}`
                      ),
                      React.createElement('td', { className: `py-3 capitalize ${TIER_CLASSES[option.tier]}` }, option.tier),
                      React.createElement('td', { className: "py-3 text-right text-gray-300" }, `${(option.probability * 100).toFixed(4)}%`)
                    )
                  ))
                )
              )
            )
          )
        )
      );

      return (
        React.createElement(React.Fragment, null,
          React.createElement('div', { className: "bg-gray-900 text-white min-h-screen p-4 sm:p-8" },
            React.createElement('main', { className: "max-w-7xl mx-auto" },
              React.createElement('header', { className: "text-center mb-10" },
                React.createElement('h1', { className: "text-4xl md:text-5xl font-bold text-yellow-400 tracking-wider" }, '마비노기 성수 시뮬레이터'),
                React.createElement('p', { className: "text-gray-400 mt-2 text-lg" }, '원하는 옵션을 얻기까지의 여정을 미리 체험해보세요.')
              ),
              React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8" },
                React.createElement('section', { 'aria-labelledby': "controls-heading", className: "bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col gap-4 h-fit order-2 lg:order-1" },
                  React.createElement('h2', { id: "controls-heading", className: "sr-only" }, '시뮬레이터 제어판'),
                  React.createElement('div', null,
                    React.createElement('label', { htmlFor: "price-input", className: "block text-sm font-medium text-gray-300 mb-2" }, '성수 개당 가격 (골드)'),
                    React.createElement('div', { className: "relative" },
                      React.createElement('span', { className: "absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400" },
                        React.createElement('i', { className: "fa-solid fa-coins" })
                      ),
                      React.createElement('input', {
                        type: "text",
                        id: "price-input",
                        value: formatNumber(price),
                        onChange: handlePriceChange,
                        className: "w-full bg-gray-700 border-gray-600 rounded-md pl-10 pr-4 py-2 text-white focus:ring-yellow-500 focus:border-yellow-500",
                        'aria-label': "성수 개당 가격"
                      })
                    )
                  ),
                  React.createElement('div', null,
                    React.createElement('label', { htmlFor: "target-option", className: "block text-sm font-medium text-gray-300 mb-2" }, '목표 옵션 (자동 실행용)'),
                    React.createElement('select', {
                        id: "target-option",
                        value: targetOption,
                        onChange: (e) => setTargetOption(e.target.value),
                        disabled: isAutoSimulating,
                        className: "w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white focus:ring-yellow-500 focus:border-yellow-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    },
                        React.createElement('option', { value: "" }, '-- 목표 옵션 선택 --'),
                        uniqueOptionNames.map(name => (
                            React.createElement('option', { key: name, value: name }, name)
                        ))
                    )
                  ),
                  React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                      React.createElement('button', { onClick: () => setIsModalOpen(true), className: "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2" },
                        React.createElement('i', { className: "fa-solid fa-table-list" }), '확률 보기'
                      ),
                      React.createElement('button', { onClick: handleReset, className: "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2" },
                        React.createElement('i', { className: "fa-solid fa-rotate-left" }), '초기화'
                      )
                  ),
                  React.createElement('button', { 
                    onClick: isAutoSimulating ? handleStopAutoSimulate : handleAutoSimulate,
                    disabled: !targetOption,
                    className: `w-full text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 ${isAutoSimulating ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} disabled:bg-gray-600 disabled:cursor-not-allowed`
                  },
                      isAutoSimulating ? React.createElement(React.Fragment, null, React.createElement('i', { className: "fa-solid fa-stop" }), '자동 실행 중지') : React.createElement(React.Fragment, null, React.createElement('i', { className: "fa-solid fa-forward-fast" }), '목표까지 자동 실행')
                  ),
                  React.createElement('div', { className: "mt-2 border-t border-gray-700 pt-4 space-y-3" },
                      React.createElement('div', { className: "flex justify-between items-baseline" },
                          React.createElement('span', { className: "text-gray-400" }, '총 시도 횟수:'),
                          React.createElement('span', { className: "text-2xl font-bold text-white" }, `${formatNumber(tryCount)}회`)
                      ),
                       React.createElement('div', { className: "flex justify-between items-baseline" },
                          React.createElement('span', { className: "text-gray-400" }, '총 사용 골드:'),
                          React.createElement('span', { className: "text-2xl font-bold text-yellow-400" }, `${formatNumber(totalCost)} G`)
                      ),
                      React.createElement('button', { onClick: handleShare, className: "w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2" },
                        React.createElement('i', {className: "fa-solid fa-share-nodes"}),
                        copyButtonText
                      )
                  )
                ),
                React.createElement('section', { 'aria-live': "polite", className: "lg:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center justify-between order-1 lg:order-2" },
                  React.createElement('h2', { className: "text-xl font-bold text-gray-300" }, '현재 옵션'),
                  React.createElement('div', { className: "flex-grow flex items-center justify-center text-center py-4" },
                    currentOption ? (
                      React.createElement('p', { className: `text-3xl md:text-4xl font-bold option-appear ${TIER_CLASSES[currentOption.tier]}` },
                        currentOption.name
                      )
                    ) : (
                      React.createElement('p', { className: "text-2xl text-gray-500" }, '버튼을 눌러 시뮬레이션을 시작하세요.')
                    )
                  ),
                  React.createElement('button', { onClick: handleSimulate, disabled: isSimulating || isAutoSimulating, className: "w-full max-w-xs bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg text-lg transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4" },
                    React.createElement('i', { className: "fa-solid fa-wand-magic-sparkles" }), isSimulating ? '적용 중...' : '성수 사용하기'
                  )
                )
              ),
              React.createElement('section', { 'aria-labelledby': "history-heading", className: "bg-gray-800 p-6 rounded-lg shadow-lg" },
                React.createElement('h2', { id: "history-heading", className: "text-xl font-bold text-gray-300 mb-4" }, '옵션 기록'),
                React.createElement('div', { className: "h-64 bg-gray-900 rounded-md p-3 overflow-y-auto" },
                    history.length > 0 ? (
                        React.createElement('ul', null,
                            history.map((opt, index) => (
                                React.createElement('li', { key: index, className: `py-1 ${index === 0 ? 'opacity-100' : 'opacity-70'}` },
                                    React.createElement('span', { className: "text-gray-500 mr-2" }, `${tryCount - index}회차:`),
                                    React.createElement('span', { className: TIER_CLASSES[opt.tier] }, opt.name)
                                )
                            ))
                        )
                    ) : (
                        React.createElement('div', { className: "flex items-center justify-center h-full text-gray-500" }, '기록이 없습니다.')
                    )
                )
              )
            )
          ),
          isModalOpen && React.createElement(ProbabilityModal)
        )
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      React.createElement(React.StrictMode, null,
        React.createElement(App)
      )
    );
  </script>
</body>
</html>